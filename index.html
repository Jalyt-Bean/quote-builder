<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sales Quote Builder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
window.addEventListener("DOMContentLoaded", () => {
  Promise.all([
    fetch("allData.json").then(res => res.json()),
    fetch("scenarios.json").then(res => res.json())
  ])
  .then(([allDataResp, scenariosResp]) => {
    allData = allDataResp;
    scenarios = scenariosResp;
    populateSheets();
  })
  .catch(err => console.error("Failed to load JSON:", err));
});

</script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f5f5f5;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    header img {
      height: 60px;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .controls {
      text-align: center;
      margin-bottom: 1rem;
    }
    select, label {
      margin: 0 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background: #0078d4;
      color: white;
    }
    tfoot td {
      font-weight: bold;
    }
    .btn {
      margin: 1rem 0.5rem;
      padding: 0.5rem 1rem;
      background: #0078d4;
      color: white;
      border: none;
      cursor: pointer;
    }
    .pm-control {
      margin-top: 1rem;
    }
    .tooltip-icon {
      margin-left: 5px;
      cursor: help;
      color: #0078d4;
      font-weight: bold;
    }
  
.tooltip-icon {
  position: relative;
  display: inline-block;
  color: #3498db;
  cursor: pointer;
  font-weight: bold;
  margin-left: 6px;
}

.tooltip-icon::after {
  content: attr(data-tooltip);
  visibility: hidden;
  opacity: 0;
  width: 240px;
  background-color: #222;
  color: #fff;
  text-align: left;
  padding: 10px;
  border-radius: 10px;
  position: absolute;
  bottom: 130%;
  left: 50%;
  transform: translateX(-50%);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  transition: opacity 0.3s ease;
  z-index: 1000;
  white-space: pre-line;
}

.tooltip-icon:hover::after {
  visibility: visible;
  opacity: 1;
}

.info-circle-icon {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background-color: #3498db;
  color: #fff;
  font-family: Arial, sans-serif;
  font-weight: bold;
  font-size: 13px;
  line-height: 20px;
  text-align: center;
  vertical-align: middle;
  cursor: pointer;
  margin-left: 6px;
  position: relative;
}

.info-circle-icon::after {
  content: attr(data-tooltip);
  visibility: hidden;
  opacity: 0;
  width: 240px;
  background-color: #222;
  color: #fff;
  text-align: left;
  padding: 10px;
  border-radius: 10px;
  position: absolute;
  bottom: 130%;
  left: 50%;
  transform: translateX(-50%);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
  transition: opacity 0.3s ease;
  z-index: 1000;
  white-space: pre-line;
}

.info-circle-icon:hover::after {
  visibility: visible;
  opacity: 1;
}
</style>
</head>
<body>

<header>
  <img src="risc.png" alt="Left Logo">
  <img src="Novem Logo with Name - Copy Larger Border.png" alt="Right Logo">
</header>

<h1>Sales Quote Builder</h1>

<div class="controls">
  <label for="sheetSelect">Select Project Type:</label>
  <select id="sheetSelect" onchange="renderTable()"></select>

  <label for="scenarioSelect" id="scenarioLabel">Select Scenario:</label>
  <select id="scenarioSelect" onchange="applyScenario()"></select>
</div>

<table id="quote-table">
  <thead>
    <tr>
      <th><input id="toggleAll" type="checkbox" onchange="toggleSelectAll(this)"> Select</th>
      <th>Task</th>
      <th>Rate Type</th>
      <th>Duration (Days)</th>
      <th>Rate Per Day</th>
      <th>Quantity</th>
      <th>Cost</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr><td colspan="6">Total Selected Cost</td><td id="total">£0.00</td></tr>
    <tr><td colspan="6">PM Fee (20%)</td><td id="pm-fee">£0.00</td></tr>
    <tr><td colspan="6">Grand Total</td><td id="grand-total">£0.00</td></tr>
    <tr><td colspan="6">Total Days Required</td><td id="total-days">0</td></tr>
  </tfoot>
</table>

<div class="pm-control">
  <label><input type="checkbox" id="pmRequired" checked onchange="calculateTotal()"> Project Management Required</label>
</div>

<div style="text-align:center">
  <button class="btn" onclick="downloadPDF()">Download PDF</button>
</div>

<script>
let allData = {};
let scenarios = {}; {};
let currentSheet = "";
const sheetSelect = document.getElementById("sheetSelect");
const scenarioSelect = document.getElementById("scenarioSelect");
const scenarioLabel = document.getElementById("scenarioLabel");
const tbody = document.querySelector("#quote-table tbody");

async function loadScenarios() {
  try {
    const res = await fetch("scenarios.json");
    scenarios = await res.json();
    populateSheets();
  } catch (err) {
    console.error("Error loading scenarios.json", err);
  }
}

function populateSheets() {
  Object.keys(allData).forEach(sheet => {
    const opt = document.createElement("option");
    opt.value = sheet;
    opt.textContent = sheet;
    sheetSelect.appendChild(opt);
  });

  if (Object.keys(allData).length > 0) {
    currentSheet = Object.keys(allData)[0];
    renderTable();
  }
}

function renderTable() {
  currentSheet = sheetSelect.value;
  tbody.innerHTML = "";
  const data = allData[currentSheet];

  data.forEach((row, index) => {
    const tr = document.createElement("tr");

    // Checkbox column
    const tdSelect = document.createElement("td");
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "select-task";
    checkbox.dataset.index = index;
    checkbox.checked = true;
    checkbox.addEventListener("change", () => updateQuantityOnSelect(index));
    tdSelect.appendChild(checkbox);
    tr.appendChild(tdSelect);

    // Task name with tooltip column
    const tdTask = document.createElement("td");
    tdTask.textContent = row["Task"] || "";
    const tooltipIcon = document.createElement("span");
    tooltipIcon.className = "tooltip-icon";
    tooltipIcon.innerHTML = "&#9432;";
    tooltipIcon.title = `Duration: ${row["Duration (Days)"] || 0}d
Rate: £${row["Rate Per Day"] || 0}`;
    tdTask.appendChild(tooltipIcon);
    tr.appendChild(tdTask);

    // Rate Type column
    const tdRateType = document.createElement("td");
    tdRateType.textContent = row["Rate Type"] || "";
    tr.appendChild(tdRateType);

    // Duration column
    const tdDuration = document.createElement("td");
    tdDuration.textContent = row["Duration (Days)"] || 0;
    tr.appendChild(tdDuration);

    // Rate Per Day column
    const tdRate = document.createElement("td");
    tdRate.textContent = row["Rate Per Day"] || 0;
    tr.appendChild(tdRate);

    // Quantity column
    const tdQty = document.createElement("td");
    const inputQty = document.createElement("input");
    inputQty.type = "number";
    inputQty.min = 0;
    inputQty.value = row.Quantity || 1;
    inputQty.className = "quantity";
    inputQty.dataset.index = index;
    inputQty.addEventListener("change", calculateTotal);
    tdQty.appendChild(inputQty);
    tr.appendChild(tdQty);

    // Cost column
    const tdCost = document.createElement("td");
    tdCost.className = "cost";
    tdCost.id = `cost-${index}`;
    tdCost.textContent = "£0.00";
    tr.appendChild(tdCost);

    tbody.appendChild(tr);
  });

  updateScenarioDropdown();
  calculateTotal();
}

function updateQuantityOnSelect(index) {
  const checkbox = document.querySelector(`.select-task[data-index="${index}"]`);
  const qtyInput = document.querySelector(`.quantity[data-index="${index}"]`);
  qtyInput.value = checkbox.checked ? 1 : 0;
  calculateTotal();
}

function toggleSelectAll(masterCheckbox) {
  const checkboxes = document.querySelectorAll(".select-task");
  checkboxes.forEach(cb => {
    const index = cb.getAttribute("data-index");
    cb.checked = masterCheckbox.checked;
    document.querySelector(`.quantity[data-index="${index}"]`).value = masterCheckbox.checked ? 1 : 0;
  });
  calculateTotal();
}

function calculateTotal() {
  let total = 0;
  let totalDays = 0;
  allData[currentSheet].forEach((row, index) => {
    const selected = document.querySelector(`.select-task[data-index="${index}"]`).checked;
    const qty = parseInt(document.querySelector(`.quantity[data-index="${index}"]`).value) || 0;
    const duration = parseFloat(row["Duration (Days)"]) || 0;
    const rate = parseFloat(row["Rate Per Day"]) || 0;
    const cost = selected ? duration * rate * qty : 0;
    const days = selected ? duration * qty : 0;
    document.getElementById(`cost-${index}`).textContent = `£${cost.toFixed(2)}`;
    total += cost;
    totalDays += days;
  });
  const pmRequired = document.getElementById("pmRequired").checked;
  const pmFee = pmRequired ? total * 0.2 : 0;
  document.getElementById("total").textContent = `£${total.toFixed(2)}`;
  document.getElementById("pm-fee").textContent = `£${pmFee.toFixed(2)}`;
  document.getElementById("grand-total").textContent = `£${(total + pmFee).toFixed(2)}`;
  document.getElementById("total-days").textContent = totalDays.toFixed(1);
}

function updateScenarioDropdown() {
  const options = scenarios[currentSheet] || {};
  scenarioSelect.style.display = "inline";
  scenarioLabel.style.display = "inline";
  scenarioSelect.innerHTML = "";

  if (Object.keys(options).length > 0) {
    scenarioSelect.innerHTML = `<option value="">-- Select Scenario --</option>`;
    Object.keys(options).forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      scenarioSelect.appendChild(opt);
    });
  } else {
    const opt = document.createElement("option");
    opt.textContent = "-- No scenarios available --";
    opt.disabled = true;
    scenarioSelect.appendChild(opt);
  }
}

function applyScenario() {
  const selectedScenario = scenarioSelect.value;
  const currentScenarios = scenarios[currentSheet] || {};
  const tasks = currentScenarios[selectedScenario];

  if (!tasks) return;

  allData[currentSheet].forEach((row, index) => {
    const taskName = row["Task"];
    const shouldSelect = tasks.hasOwnProperty(taskName);
    const qty = shouldSelect ? tasks[taskName] : 0;
    document.querySelector(`.select-task[data-index="${index}"]`).checked = shouldSelect;
    document.querySelector(`.quantity[data-index="${index}"]`).value = qty;
  });

  calculateTotal();
}

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text(`Quote - ${currentSheet}`, 10, 10);
  let y = 20;

  allData[currentSheet].forEach((row, index) => {
    const selected = document.querySelector(`.select-task[data-index="${index}"]`).checked;
    const qty = parseInt(document.querySelector(`.quantity[data-index="${index}"]`).value) || 0;
    const duration = parseFloat(row["Duration (Days)"]) || 0;
    const rate = parseFloat(row["Rate Per Day"]) || 0;
    if (selected && (duration > 0 || rate > 0)) {
      const cost = duration * rate * qty;
      doc.text(`- ${row["Task"] || "Untitled Task"}: £${cost.toFixed(2)}`, 10, y);
      y += 10;
    }
  });

  y += 10;
  doc.text(`Total: ${document.getElementById("total").textContent}`, 10, y);
  doc.text(`PM Fee (20%): ${document.getElementById("pm-fee").textContent}`, 10, y + 10);
  doc.text(`Grand Total: ${document.getElementById("grand-total").textContent}`, 10, y + 20);
  doc.text(`Total Days Required: ${document.getElementById("total-days").textContent}`, 10, y + 30);

  doc.save(`${currentSheet}_quote.pdf`);
}

window.addEventListener("DOMContentLoaded", loadScenarios);

window.addEventListener("DOMContentLoaded", () => {
  Promise.all([
    fetch("allData.json").then(res => res.json()),
    fetch("scenarios.json").then(res => res.json())
  ])
  .then(([allDataResp, scenariosResp]) => {
    allData = allDataResp;
    scenarios = scenariosResp;
    populateSheets();
  })
  .catch(err => console.error("Failed to load JSON:", err));
});

</script>

</body>
</html>
