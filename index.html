<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quote Builder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f5f5f5;
    }
    h1, select {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background: #0078d4;
      color: white;
    }
    tfoot td {
      font-weight: bold;
    }
    .btn {
      margin: 1rem 0.5rem;
      padding: 0.5rem 1rem;
      background: #0078d4;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Sales Quote Builder</h1>
  <div style="text-align:center; margin-bottom:1rem;">
    <label for="sheetSelect">Select Project Type:</label>
    <select id="sheetSelect" onchange="renderTable()"></select>
  </div>

  <table id="quote-table">
    <thead>
      <tr>
        <th>Select</th>
        <th>Task</th>
        <th>Rate Type</th>
        <th>Duration (Days)</th>
        <th>Rate Per Day</th>
        <th>Quantity</th>
        <th>Cost</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="6">Total Selected Cost</td>
        <td id="total">0</td>
      </tr>
      <tr>
        <td colspan="6">PM Fee (20%)</td>
        <td id="pm-fee">0</td>
      </tr>
      <tr>
        <td colspan="6">Grand Total</td>
        <td id="grand-total">0</td>
      </tr>
    </tfoot>
  </table>

  <div style="text-align:center">
    <button class="btn" onclick="calculateTotal()">Calculate Total</button>
    <button class="btn" onclick="downloadPDF()">Download PDF</button>
  </div>

  <script>
    const allData = REPLACE_WITH_DATA;
    let currentSheet = Object.keys(allData)[0];

    const sheetSelect = document.getElementById("sheetSelect");
    const tbody = document.querySelector("#quote-table tbody");

    Object.keys(allData).forEach(sheet => {
      const opt = document.createElement("option");
      opt.value = sheet;
      opt.textContent = sheet;
      sheetSelect.appendChild(opt);
    });

    function renderTable() {
      currentSheet = sheetSelect.value;
      tbody.innerHTML = "";
      allData[currentSheet].forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" class="select-task" data-index="${index}" checked></td>
          <td>${row["Task"]}</td>
          <td>${row["Rate Type"]}</td>
          <td>${row["Duration (Days)"]}</td>
          <td>${row["Rate Per Day"]}</td>
          <td><input type="number" value="${row.Quantity || 1}" min="1" class="quantity" data-index="${index}"></td>
          <td class="cost" id="cost-${index}">0</td>
        `;
        tbody.appendChild(tr);
      });
      calculateTotal();
    }

    function calculateTotal() {
      let total = 0;
      allData[currentSheet].forEach((row, index) => {
        const selected = document.querySelector(`.select-task[data-index='${index}']`).checked;
        const qty = parseInt(document.querySelector(`.quantity[data-index='${index}']`).value) || 0;
        const cost = selected ? row["Duration (Days)"] * row["Rate Per Day"] * qty : 0;
        document.getElementById(`cost-${index}`).textContent = `£${cost.toFixed(2)}`;
        total += cost;
      });
      const pm = total * 0.2;
      document.getElementById("total").textContent = `£${total.toFixed(2)}`;
      document.getElementById("pm-fee").textContent = `£${pm.toFixed(2)}`;
      document.getElementById("grand-total").textContent = `£${(total + pm).toFixed(2)}`;
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);

      doc.text(`Quote - ${currentSheet}`, 10, 10);

      let y = 20;
      allData[currentSheet].forEach((row, index) => {
        const selected = document.querySelector(`.select-task[data-index='${index}']`).checked;
        const qty = parseInt(document.querySelector(`.quantity[data-index='${index}']`).value) || 0;
        if (selected) {
          const cost = row["Duration (Days)"] * row["Rate Per Day"] * qty;
          doc.text(`- ${row["Task"]}: £${cost.toFixed(2)}`, 10, y);
          y += 10;
        }
      });

      y += 10;
      doc.text(`Total: ${document.getElementById("total").textContent}`, 10, y);
      doc.text(`PM Fee (20%): ${document.getElementById("pm-fee").textContent}`, 10, y + 10);
      doc.text(`Grand Total: ${document.getElementById("grand-total").textContent}`, 10, y + 20);

      doc.save(`${currentSheet}_quote.pdf`);
    }

    renderTable();
  </script>
</body>
</html>
