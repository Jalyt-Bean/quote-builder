<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Professional Services Labour Estimator</title>
<style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    select, label {
      margin: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #0078d4;
      color: white;
    }
    .tooltip-icon {
      margin-left: 6px;
      cursor: pointer;
      color: #0078d4;
      font-weight: bold;
    }
    .summary-card {
      background: #fff;
      padding: 1rem;
      margin-top: 2rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .summary-card h3 {
      margin-top: 0;
      color: #0078d4;
    }
    .summary-line {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
    }
  </style>
</head>
<body>
<h1>Professional Services Labour Estimator</h1>
<label for="projectSelect">Project Type:</label>
<select id="projectSelect"></select>
<label for="scenarioSelect">Scenario:</label>
<select id="scenarioSelect"></select>
<table id="taskTable">
<thead>
<tr>
<th><input id="toggleAll" type="checkbox"/></th>
<th>Task</th>
<th>Rate Type</th>
<th>Duration (Days)</th>
<th>Rate Per Day</th>
<th>Quantity</th>
<th>Cost</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div class="summary-card">
<h3>Quote Summary</h3>
<div class="summary-line"><span>Total Selected Cost:</span><span id="total">£0.00</span></div>
<div class="summary-line"><span>PM Fee (20%):</span><span id="pm-fee">£0.00</span></div>
<div class="summary-line"><span>Grand Total:</span><span id="grand-total">£0.00</span></div>
<div class="summary-line"><span>Total Days Required:</span><span id="total-days">0</span></div>
<div class="summary-line"><label><input checked="" id="pmRequired" onchange="calculateTotal()" type="checkbox"/> Project Management Required</label></div>
</div>
<script>
let allData = {};
let scenarios = {};
let tooltips = {};
let currentSheet = "";
let selections = {};

window.addEventListener("DOMContentLoaded", () => {
  Promise.all([
    fetch("allData.json").then(res => res.json()),
    fetch("scenarios.json").then(res => res.json()),
    fetch("tooltips.json").then(res => res.json())
  ])
  .then(([allDataResp, scenariosResp, tooltipsResp]) => {
    allData = allDataResp;
    scenarios = scenariosResp;
    tooltips = tooltipsResp;
    populateSheets();
  })
  .catch(err => console.error("Failed to load JSON:", err));
});

function populateSheets() {
  const sheetSelect = document.getElementById("sheetSelect");
  sheetSelect.innerHTML = "";
  Object.keys(allData).forEach(sheet => {
    const opt = document.createElement("option");
    opt.value = sheet;
    opt.textContent = sheet;
    sheetSelect.appendChild(opt);
  });
  if (Object.keys(allData).length > 0) {
    currentSheet = Object.keys(allData)[0];
    renderTable();
  }
}

function renderTable() {
  currentSheet = document.getElementById("sheetSelect").value;
  if (!selections[currentSheet]) {
    selections[currentSheet] = allData[currentSheet].map(() => ({ selected: false, qty: 0 }));
  }
  const tbody = document.querySelector("#quote-table tbody");
  tbody.innerHTML = "";
  allData[currentSheet].forEach((row, index) => {
    const tr = document.createElement("tr");

    const tdSelect = document.createElement("td");
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "select-task";
    checkbox.dataset.index = index;
    checkbox.checked = selections[currentSheet][index].selected;
    checkbox.addEventListener("change", () => updateQuantityOnSelect(index));
    tdSelect.appendChild(checkbox);
    tr.appendChild(tdSelect);

    const tdTask = document.createElement("td");
    tdTask.textContent = row["Task"] || "";
    const tooltipIcon = document.createElement("span");
    tooltipIcon.className = "tooltip-icon";
    tooltipIcon.innerHTML = "&#9432;";
    const key = row["Task"]?.trim().toLowerCase();
    tooltipIcon.title = tooltips[key] || "No tooltip available.";
    tdTask.appendChild(tooltipIcon);
    tr.appendChild(tdTask);

    ["Rate Type", "Duration (Days)", "Rate Per Day"].forEach(field => {
      const td = document.createElement("td");
      td.textContent = row[field] || "";
      tr.appendChild(td);
    });

    const tdQty = document.createElement("td");
    const inputQty = document.createElement("input");
    inputQty.type = "number";
    inputQty.min = 0;
    inputQty.value = selections[currentSheet][index].qty;
    inputQty.className = "quantity";
    inputQty.dataset.index = index;
    inputQty.addEventListener("change", calculateTotal);
    tdQty.appendChild(inputQty);
    tr.appendChild(tdQty);

    const tdCost = document.createElement("td");
    tdCost.className = "cost";
    tdCost.id = `cost-${index}`;
    tdCost.textContent = "£0.00";
    tr.appendChild(tdCost);

    tbody.appendChild(tr);
  });

  calculateTotal();
}

function updateQuantityOnSelect(index) {
  const cb = document.querySelector(`.select-task[data-index="${index}"]`);
  const qty = cb.checked ? 1 : 0;
  selections[currentSheet][index] = { selected: cb.checked, qty };
  document.querySelector(`.quantity[data-index="${index}"]`).value = qty;
  calculateTotal();
}

function calculateTotal() {
  let total = 0, totalDays = 0, psDays = 0, engDays = 0, consDays = 0;

  Object.keys(allData).forEach(projectType => {
    const rows = allData[projectType];
    if (!selections[projectType]) return;
    selections[projectType].forEach((sel, index) => {
      if (!sel.selected) return;
      const row = rows[index];
      const duration = parseFloat(row["Duration (Days)"]) || 0;
      const rate = parseFloat(row["Rate Per Day"]) || 0;
      const rateType = (row["Rate Type"] || "").toLowerCase();
      const qty = sel.qty;
      const cost = duration * rate * qty;
      const days = duration * qty;
      total += cost;
      totalDays += days;
      if (rateType.includes("consultancy")) consDays += days;
      else if (rateType.includes("engineering")) engDays += days;
      else psDays += days;
      if (projectType === currentSheet) {
        const costCell = document.getElementById(`cost-${index}`);
        if (costCell) costCell.textContent = `£${cost.toFixed(2)}`;
      }
    });
  });

  const pmFee = total * 0.2;
  document.getElementById("total").textContent = `£${total.toFixed(2)}`;
  document.getElementById("pm-fee").textContent = `£${pmFee.toFixed(2)}`;
  document.getElementById("grand-total").textContent = `£${(total + pmFee).toFixed(2)}`;
  document.getElementById("ps-days").textContent = psDays.toFixed(1);
  document.getElementById("eng-days").textContent = engDays.toFixed(1);
  document.getElementById("cons-days").textContent = consDays.toFixed(1);
  document.getElementById("total-days").textContent = totalDays.toFixed(1);
}
</script>
</body>
</html>
